<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>bpmizador</title>
<style>
    noscript { color: red; }
</style>
</head>
<body>
<h1>bpmizador</h1><hr>

<noscript><strong>You need to enable JavaScript for bpmizador to work</strong></noscript>

Instructions:
<ol>
    <li>Press <kbd>X</kbd> on every beat to calculate the bpm</li>
    <li>Take note of the resulting bpm</li>
    <li>Press <kbd>R</kbd> to clear the current value and start all over</li>
</ol>

Input:
<ol>
    <li id="1"></li>
    <li id="2"></li>
    <li id="3"></li>
    <li id="4"></li>
    <li id="5"></li>
    <li id="6"></li>
    <li id="7"></li>
    <li id="8"></li>
</ol>

<strong>BPM</strong>: <span id="bpm">??</span><br><br>
Average elapsed time: <span id="avg">??</span><br>

<br>
<details>
    <summary>For devices with no keyboard</summary>
    <input type="button" id="beat-btn" value="Add beat"><br><br>
    <input type="button" id="reset-beats-btn" value="Reset">
</details>

<script>
    var registered_beats = 0;     // 0-8 beats
    var beats = [];               // 1-8, in miliseconds
    var beats_elapsed_times = []; // 2-8, in miliseconds
    var average_elapsed_time = 0; // Average elapsed time between beats, in miliseconds
    var bpm = -1;                 // -1 means "not calculated yet"

    var resetValues = function() {
        registered_beats = 0;
        beats = [];
        beats_elapsed_times = [];
        average_elapsed_time = 0;
        bpm = -1;
    }

    var render = function() {
        // Render beats
        if(registered_beats > 0) {
            for(var i=1; i<=registered_beats; i++) {
                document.getElementById(i).innerHTML = beats[i] + "ms";

                // If the beat has an elapsed time since its previous, display it
                if(i>1) {
                    document.getElementById(i).innerHTML += " (+"  + beats_elapsed_times[i]  + "ms)";
                }
            }
        } else {
            for(var i=1; i<=8; i++) {
                document.getElementById(i).innerHTML = "";
            }
        }

        // Render the average elapsed time
        if(registered_beats > 1) { document.getElementById("avg").innerHTML = Math.trunc(average_elapsed_time) + "ms"; }
        else                     { document.getElementById("avg").innerHTML = "??";                                    }

        // Render BPM
        if(bpm > 0) { document.getElementById("bpm").innerHTML = Math.trunc(bpm) + " (" + bpm.toFixed(2) + ")"; }
        else        { document.getElementById("bpm").innerHTML = "??";                                          }
    }

    var attemptToRegisterNewBeat = function() {
        // Register the current beat timestamp if it doesn't exceed the beats limit
        if(registered_beats < 8) { beats[++registered_beats] = Date.now(); }
        else                     { return; }

        // Register the elapsed time since the last beat if it's possible
        if(registered_beats > 1) {
            beats_elapsed_times[registered_beats] = beats[registered_beats] - beats[registered_beats-1];
        }

        // Calculate the current BPM if it's possible
        if(registered_beats > 1) {
            // Calculate the average elapsed time between beats, in ms
            var sum = beats[registered_beats] - beats[1];
            average_elapsed_time = sum/(registered_beats-1);

            // Convert it to seconds
            var avg_in_s = average_elapsed_time/1000;

            // Rule of three to discover the bpm (beats in 60 seconds)
            /*
            # beats            | timespan
            #------------------|-----------------------------
            # registered_beats | avg_in_s * registered_beats
            #       bpm        | 60 s
            #
            */
            bpm = (registered_beats * 60)/(avg_in_s*registered_beats);
        }

        // Render the results
        render();
    }

    var resetBeats = function() {
        resetValues();
        render();
    }

    var keypressHandler = function(e) {
        if(e.code == "KeyX") {
            attemptToRegisterNewBeat();
        }

        if(e.code == "KeyR") {
            resetBeats();
        }
    }

    window.addEventListener("keypress", keypressHandler, false);

    document.getElementById("beat-btn").addEventListener("click", attemptToRegisterNewBeat, false);
    document.getElementById("reset-beats-btn").addEventListener("click", resetBeats, false);
</script>
</body>
</html>
